name: Tests

on:
  push:
  pull_request:

jobs:
  unit:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup uv and deps
        uses: ./.github/actions/python-setup
        with:
          python-version: ${{ matrix.python-version }}
          install-args: ".[dev]"
          cache-suffix: "${{ runner.os }}-${{ matrix.python-version }}"

      - name: Run pytest (parallel, randomized)
        run: |
          export PYTEST_ADDOPTS="--randomly-seed=${{ github.run_number }}${{ github.run_attempt }}"
          uv run -q -m pytest -n auto --cov=gh_pr_rev_md --cov-report=xml --cov-report=term

      - name: Upload coverage to Codecov
        if: success()
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false


